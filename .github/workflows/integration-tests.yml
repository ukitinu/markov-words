name: Integration tests

#
# Unit and integration tests, with coverage report badge for PR NOT on master and develop branches
#

on:
  pull_request:
    # ** matches every branch name, but master and develop are filtered out afterwards
    branches:
      - '**'
      - '!master'
      - '!develop'

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK
        uses: actions/setup-java@v2
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
      - name: Test
        run: mvn verify --batch-mode --fail-at-end

      # publishes data of failed tests
      - name: Publish reports
        # to ensure it proceeds in case of test failures
        if: ${{ always() }}
        uses: ScaCap/action-surefire-report@v1
        with:
          # ignore surefire reports (unit tests)
          report_paths: '**/failsafe-reports/TEST-*.xml'
          # default is false, another action will fail the pipeline if there are test failures
          fail_on_test_failures: false
          # default is true, another action will fail the pipeline if there are no tests
          fail_if_no_tests: false
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # adds a comment which shows coverage ratio
      - name: Report coverage
        id: jacoco
        uses: Madrapps/jacoco-report@v1.2
        with:
          paths: './target/site/jacoco-merged-report/jacoco.xml'
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: env.COV_TOT
          min-coverage-changed-files: env.COV_NEW